@page "/"
@using BobFx.Core.Services
@inject CountdownService CountdownService
@implements IDisposable

<PageTitle>Home</PageTitle>

<div class="home-container">
    <h1>BobFx Controller</h1>

    <div class="countdown-section">
   @if (!CountdownService.IsRunning && !CountdownService.IsPreCountdownRunning)
{
   <div class="duration-controls">
       <h3>Set Duration</h3>
       <div class="time-inputs">
  <div class="time-input-group">
          <label>Minutes:</label>
 <input type="number" @bind="minutes" min="0" max="60" />
  </div>
 <div class="time-input-group">
     <label>Seconds:</label>
   <input type="number" @bind="seconds" min="0" max="59" />
     </div>
         </div>

      <div class="pre-countdown-section">
         <div class="pre-countdown-toggle">
         <input type="checkbox" id="enablePreCountdown" @bind="enablePreCountdown" class="form-check-input" />
 <label for="enablePreCountdown">Enable Pre-Countdown</label>
     </div>
         
    @if (enablePreCountdown)
    {
   <div class="pre-countdown-input">
       <label>Pre-Countdown (seconds):</label>
           <input type="number" @bind="preCountdownSeconds" min="1" max="60" />
    </div>
   }
 </div>
    </div>

            <button class="btn-countdown btn-start" @onclick="StartCountdown">
<span class="btn-icon">▶</span>
          <span class="btn-text">Start Countdown</span>
            </button>
        }
        else if (CountdownService.IsPreCountdownRunning)
  {
        <div class="pre-countdown-display">
          <div class="pre-countdown-label">Pre-Countdown Active</div>
     <div class="pre-countdown-message">Get Ready!</div>
  </div>
   <button class="btn-countdown btn-stop" @onclick="StopCountdown">
    <span class="btn-icon">■</span>
           <span class="btn-text">Stop</span>
         </button>
        }
    else
        {
       <button class="btn-countdown btn-stop" @onclick="StopCountdown">
       <span class="btn-icon">■</span>
      <span class="btn-text">Stop Countdown</span>
  </button>
      }
    </div>
</div>

@code {
    private int minutes = 15;
    private int seconds = 0;
    private bool enablePreCountdown = false;
    private int preCountdownSeconds = 3;

    protected override void OnInitialized()
    {
 CountdownService.OnTick += OnTick;
    }

    private void OnTick()
    {
      InvokeAsync(StateHasChanged);
    }

    private async Task StartCountdown()
    {
 var mainDuration = new TimeSpan(0, minutes, seconds);
    
     if (enablePreCountdown)
    {
     var preDuration = TimeSpan.FromSeconds(preCountdownSeconds);
  await CountdownService.StartWithPreCountdownAsync(preDuration, mainDuration);
        }
      else
    {
   CountdownService.Start(mainDuration);
        }
    }

 private void StopCountdown()
    {
        CountdownService.Stop();
    }

    public void Dispose()
    {
        CountdownService.OnTick -= OnTick;
    }
}
